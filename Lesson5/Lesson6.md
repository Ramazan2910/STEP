# Темы урока: Транзакции 
- Что такое транзакции
- Зачем нужны транзакции 
- ACID
- Примеры транзакций
- 
- подзапросы

## Что такое транзакции ? 

`Транзакция` - это последовательность операций, которые выполняются как единое целое. 
Транзакции используются для обеспечения целостности базы данных.

Тут важно понять что это последовательность операций, например мы можем создать таблицу
и сразу заполнить его данными. Мы можем сделать это как в одной транзкации так и в двух.

Если во время транзакции произойдет ошибка, то все изменения откатываются, 
и база данных остается в прежнем состоянии.


## Зачем нужны транзакции ?

Транзакции нужны для обеспечения целостности данных.

При добавлении данных в базу данных, мы можем столкнуться с ситуацией, когда
во время добавления данных произойдет ошибка. Например, мы добавляем данные в две таблицы,
и во время добавления данных во вторую таблицу произойдет ошибка. В этом случае,
данные в первой таблице будут добавлены, а данные во второй таблице нет. В случае если они 
должны быть связаны, то это приведет к ошибке.

Транзакции позволяют избежать таких ситуаций. Если во время транзакции произойдет ошибка,
то все изменения откатываются, и база данных остается в прежнем состоянии.

## ACID
- Atomicity (Атомарность)
- Consistency (Согласованность)
- Isolation (Изолированность)
- Durability (Долговечность)


### Atomicity (Атомарность)
Атомарность гарантирует, что транзакция либо выполняется полностью, либо не выполняется вообще.

### Consistency (Согласованность)
Согласованность гарантирует, что транзакция переводит базу данных из одного согласованного состояния в другое согласованное состояние. ( Если транзакция началась либо 100% да скажет или нет )

### Isolation (Изолированность)
Изолированность гарантирует, что транзакция не влияет на другие транзакции. ( К примеры если запустить две транзакции одновременно они не повлияют друг на друга )

### Durability (Долговечность)
Долговечность гарантирует, что изменения, внесенные транзакцией, сохраняются даже в случае сбоя системы.


## Примеры транзакций

Пример транзакции на SQL:

```sql

BEGIN TRANSACTION;

INSERT INTO users (name, email) VALUES ('John Doe', 'john.doe@gmail.com');
INSERT INTO orders (user_id, product_id) VALUES (1, 1);

COMMIT;

```

В этом примере мы добавляем пользователя в таблицу `users` и заказ в таблицу `orders`.

Если во время выполнения транзакции произойдет ошибка, то все изменения откатываются.

Любая транзакция начинается со слова `BEGIN TRANSACTION`.

`COMMIT` - для того чтобы подтвердить транзакцию. 


Также мы можем давать им имена и откатывать их в случае если нам не нужны эти изменения: 

```sql

BEGIN TRANSACTION my_transaction;

INSERT INTO users (name, email) VALUES ('John Doe', 'profbat018@gmail.com`);

ROLLBACK my_transaction;

```

Даже если вы не написали commit, вы увидите что данные добавились. 
Это происходит для того чтобы вы могли все проверить и если что сделать 
rollback 

### SAVEPOINT 

Использование `SAVEPOINT` для частичного отката. Если в транзакции есть несколько шагов, можно откатываться не полностью, а до определённого момента с помощью `SAVEPOINT`.

```sql
START TRANSACTION;

UPDATE accounts SET balance = balance - 200 WHERE id = 1;
SAVEPOINT after_alice;  -- Создаём точку сохранения

UPDATE accounts SET balance = balance + 200 WHERE id = 2;

-- Внезапно обнаружили ошибку! Откатываемся только до SAVEPOINT:
ROLLBACK TO SAVEPOINT after_alice;

-- Теперь баланс Bob не изменился, но у Alice всё ещё -200

-- Если всё нормально, фиксируем изменения:
COMMIT;
```

📌 ROLLBACK TO SAVEPOINT after_alice; откатит только последнюю операцию (перевод Bob), но оставит изменение баланса Alice.

## Подзапросы


```sql
alter table Teacher
add SubjectId int foreign key references Subject(Id)


select p.Name, s.SubjectName, s.Id, AVG(sp.Point) as AvgPoint from dbo.Student
inner join dbo.StudentPoint SP on dbo.Student.Id = SP.StudentId
inner join dbo.Subject S on S.Id = SP.SubjectId
 join dbo.People P on P.Id = Student.PersonId
where SP.Point >= (select AVG(Point) from StudentPoint)
group by p.Name, s.SubjectName, s.Id




select * from Teacher

update Teacher
set Teacher.SubjectId = (
select Id from Subject
    where Subject.SubjectName = Teacher.Subject
    )
where Teacher.SubjectId is null
```











